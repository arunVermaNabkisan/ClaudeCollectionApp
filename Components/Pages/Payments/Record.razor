@page "/Payments/Record"
@using ClaudeCollectionApp.Models.Entities
@using ClaudeCollectionApp.Models.Enums
@using ClaudeCollectionApp.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IPaymentService PaymentService
@inject ICaseManagementService CaseService
@inject NavigationManager NavigationManager

<PageTitle>Record Payment - Collection Management</PageTitle>

<div class="page-container">
    <div class="page-header">
        <div>
            <h1>Record Payment</h1>
            <p>Record a new payment for a loan account</p>
        </div>
    </div>

    <div class="form-container">
        <EditForm Model="@paymentModel" OnValidSubmit="RecordPayment">
            <DataAnnotationsValidator />

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            <div class="form-section">
                <h3>Payment Details</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label>Loan Account Number *</label>
                        <InputText class="form-control" @bind-Value="paymentModel.LoanAccountNumber" placeholder="Enter loan account number" />
                        <ValidationMessage For="@(() => paymentModel.LoanAccountNumber)" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Amount *</label>
                        <InputNumber class="form-control" @bind-Value="paymentModel.Amount" placeholder="Enter amount" />
                        <ValidationMessage For="@(() => paymentModel.Amount)" />
                    </div>

                    <div class="form-group">
                        <label>Payment Mode *</label>
                        <InputSelect class="form-select" @bind-Value="paymentModel.PaymentMode">
                            <option value="">Select payment mode</option>
                            @foreach (var mode in Enum.GetValues<PaymentMode>())
                            {
                                <option value="@mode">@mode</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => paymentModel.PaymentMode)" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Transaction ID</label>
                        <InputText class="form-control" @bind-Value="paymentModel.TransactionId" placeholder="Enter transaction ID" />
                    </div>

                    <div class="form-group">
                        <label>Bank Reference Number</label>
                        <InputText class="form-control" @bind-Value="paymentModel.BankReferenceNumber" placeholder="Enter bank reference" />
                    </div>
                </div>

                @if (paymentModel.PaymentMode == PaymentMode.UPI)
                {
                    <div class="form-row">
                        <div class="form-group">
                            <label>UPI Reference Number</label>
                            <InputText class="form-control" @bind-Value="paymentModel.UPIReferenceNumber" placeholder="Enter UPI reference" />
                        </div>
                    </div>
                }

                @if (paymentModel.PaymentMode == PaymentMode.Cheque)
                {
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cheque Number</label>
                            <InputText class="form-control" @bind-Value="paymentModel.ChequeNumber" placeholder="Enter cheque number" />
                        </div>

                        <div class="form-group">
                            <label>Cheque Date</label>
                            <InputDate class="form-control" @bind-Value="paymentModel.ChequeDate" />
                        </div>
                    </div>
                }
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                    @if (isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span> Processing...</span>
                    }
                    else
                    {
                        <span>Record Payment</span>
                    }
                </button>
                <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">Cancel</button>
            </div>
        </EditForm>
    </div>
</div>

<style>
    .form-container {
        background: white;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        max-width: 800px;
    }

    .form-section {
        margin-bottom: 32px;
    }

    .form-section h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e2e8f0;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-size: 14px;
        font-weight: 500;
        color: #4a5568;
        margin-bottom: 8px;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        padding-top: 24px;
        border-top: 1px solid #e2e8f0;
    }

    .alert {
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
    }

    .alert-success {
        background: #c6f6d5;
        color: #22543d;
        border: 1px solid #9ae6b4;
    }

    .alert-danger {
        background: #fed7d7;
        color: #742a2a;
        border: 1px solid #fc8181;
    }
</style>

@code {
    [SupplyParameterFromQuery] public Guid? CaseId { get; set; }

    private PaymentModel paymentModel = new();
    private string? errorMessage;
    private string? successMessage;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        if (CaseId.HasValue)
        {
            var case_ = await CaseService.GetCaseByIdAsync(CaseId.Value);
            if (case_ != null)
            {
                paymentModel.LoanAccountNumber = case_.LoanAccount.LoanAccountNumber;
            }
        }
    }

    private async Task RecordPayment()
    {
        try
        {
            isProcessing = true;
            errorMessage = null;
            successMessage = null;

            // Find loan account by number
            var loanAccount = await FindLoanAccountByNumber(paymentModel.LoanAccountNumber);

            if (loanAccount == null)
            {
                errorMessage = "Loan account not found";
                return;
            }

            var additionalDetails = new Dictionary<string, string>();

            if (!string.IsNullOrEmpty(paymentModel.TransactionId))
                additionalDetails["TransactionId"] = paymentModel.TransactionId;

            if (!string.IsNullOrEmpty(paymentModel.BankReferenceNumber))
                additionalDetails["BankReferenceNumber"] = paymentModel.BankReferenceNumber;

            if (!string.IsNullOrEmpty(paymentModel.UPIReferenceNumber))
                additionalDetails["UPIReferenceNumber"] = paymentModel.UPIReferenceNumber;

            if (!string.IsNullOrEmpty(paymentModel.ChequeNumber))
                additionalDetails["ChequeNumber"] = paymentModel.ChequeNumber;

            if (paymentModel.ChequeDate.HasValue)
                additionalDetails["ChequeDate"] = paymentModel.ChequeDate.Value.ToString("yyyy-MM-dd");

            var payment = await PaymentService.RecordPaymentAsync(
                loanAccount.Id,
                paymentModel.Amount,
                paymentModel.PaymentMode,
                additionalDetails
            );

            successMessage = $"Payment recorded successfully! Reference: {payment.PaymentReferenceNumber}";

            // Reset form
            paymentModel = new PaymentModel();

            // Navigate back after a short delay
            await Task.Delay(2000);
            if (CaseId.HasValue)
            {
                NavigationManager.NavigateTo($"/Cases/{CaseId.Value}");
            }
            else
            {
                NavigationManager.NavigateTo("/Payments");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error recording payment: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void Cancel()
    {
        if (CaseId.HasValue)
        {
            NavigationManager.NavigateTo($"/Cases/{CaseId.Value}");
        }
        else
        {
            NavigationManager.NavigateTo("/Payments");
        }
    }

    // Helper method - in real implementation, this would use a service
    private async Task<LoanAccount?> FindLoanAccountByNumber(string accountNumber)
    {
        // This is a placeholder - implement proper lookup via service
        return await Task.FromResult<LoanAccount?>(null);
    }

    private class PaymentModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Loan account number is required")]
        public string LoanAccountNumber { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Amount is required")]
        [System.ComponentModel.DataAnnotations.Range(1, double.MaxValue, ErrorMessage = "Amount must be greater than 0")]
        public decimal Amount { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Payment mode is required")]
        public PaymentMode PaymentMode { get; set; }

        public string? TransactionId { get; set; }
        public string? BankReferenceNumber { get; set; }
        public string? UPIReferenceNumber { get; set; }
        public string? ChequeNumber { get; set; }
        public DateTime? ChequeDate { get; set; }
    }
}
